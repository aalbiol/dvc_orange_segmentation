schema: '2.0'
stages:
  split_train_val:
    cmd: python ../src_view_segmentation/data/split_train_val.py config/config.yaml
    deps:
    - path: ../src_view_segmentation/data/split_train_val.py
      hash: md5
      md5: 6a1de9c230dd38f02b06146a52247699
      size: 3080
    params:
      config/config.yaml:
        data:
          prob_train: 0.8
          training_size:
          - 150
          - 150
          crop_size:
          delimiter: _
          maxvalues:
          - 255
          - 1023
          - 1023
          root_folder: data
          suffixes:
          - _RGB.png
          - _NIR.png
          - _UV.png
          channel_list:
          use_segmentation_masks: true
          train:
          - - train_list.txt
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/jsons
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/images
          - - train_list.txt
            - 20240220_142555_Img_20240220_goods/jsons
            - 20240220_142555_Img_20240220_goods/images
          - - train_list.txt
            - 20240312_210918_prod/jsons
            - 20240312_210918_prod/images
          - - train_list.txt
            - 20240312_210929_prod/jsons
            - 20240312_210929_prod/images
          - - train_list.txt
            - 20240321_162918_Img_20240321_162913/jsons
            - 20240321_162918_Img_20240321_162913/images
          - - train_list.txt
            - 20240321_172502_defectos_rotando/jsons
            - 20240321_172502_defectos_rotando/images
          - - train_list.txt
            - 20240805/jsons
            - 20240805/images
          val:
          - - val_list.txt
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/jsons
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/images
          - - val_list.txt
            - 20240220_142555_Img_20240220_goods/jsons
            - 20240220_142555_Img_20240220_goods/images
          - - val_list.txt
            - 20240312_210918_prod/jsons
            - 20240312_210918_prod/images
          - - val_list.txt
            - 20240312_210929_prod/jsons
            - 20240312_210929_prod/images
          - - val_list.txt
            - 20240321_162918_Img_20240321_162913/jsons
            - 20240321_162918_Img_20240321_162913/images
          - - val_list.txt
            - 20240321_172502_defectos_rotando/jsons
            - 20240321_172502_defectos_rotando/images
          - - val_list.txt
            - 20240805/jsons
            - 20240805/images
    outs:
    - path: data/20240219_190526_Img_20240219_NaranjaRottEncoder/jsons/train_list.txt
      hash: md5
      md5: 65101ae8e7482f1e23e6bef2496560c6
      size: 12390
    - path: data/20240219_190526_Img_20240219_NaranjaRottEncoder/jsons/val_list.txt
      hash: md5
      md5: 61120de65ea6fa40de7ff54dc02167f4
      size: 4230
    - path: data/20240220_142555_Img_20240220_goods/jsons/train_list.txt
      hash: md5
      md5: 32e9c4e320b01e3bba2f0fb9736868c0
      size: 8640
    - path: data/20240220_142555_Img_20240220_goods/jsons/val_list.txt
      hash: md5
      md5: 4fe2f2179a5caf6c99559971a976c1d9
      size: 2520
    - path: data/20240312_210918_prod/jsons/train_list.txt
      hash: md5
      md5: 12f884919de6b5f1139ce4ee9627afc7
      size: 35550
    - path: data/20240312_210918_prod/jsons/val_list.txt
      hash: md5
      md5: 9b4e8e83ac8509421983dbb6621983ba
      size: 9570
    - path: data/20240312_210929_prod/jsons/train_list.txt
      hash: md5
      md5: 7abb228ce2f4aadd1301a437eba35e19
      size: 28140
    - path: data/20240312_210929_prod/jsons/val_list.txt
      hash: md5
      md5: 791825f0e7872f90d321fec3a199f2d6
      size: 7680
    - path: data/20240321_162918_Img_20240321_162913/jsons/train_list.txt
      hash: md5
      md5: 7a68ac2d9a411bba667fc3cecc4d8fd3
      size: 10140
    - path: data/20240321_162918_Img_20240321_162913/jsons/val_list.txt
      hash: md5
      md5: 3805fefe7d83122846f8816da192c5f5
      size: 2370
    - path: data/20240321_172502_defectos_rotando/jsons/train_list.txt
      hash: md5
      md5: d03dc92b3039e15b25a4372c38299649
      size: 5310
    - path: data/20240321_172502_defectos_rotando/jsons/val_list.txt
      hash: md5
      md5: 3bc4c16199cd7f9383f6288f6a929243
      size: 1680
    - path: data/20240805/jsons/train_list.txt
      hash: md5
      md5: 688b049ed24e411f5e175f996888a137
      size: 67320
    - path: data/20240805/jsons/val_list.txt
      hash: md5
      md5: 66eb3096129982286c54ef13b45889e7
      size: 16470
  train:
    cmd: python ../src_view_segmentation/train/trainMIL.py config/config.yaml
    deps:
    - path: ../src_view_segmentation/train/trainMIL.py
      hash: md5
      md5: ec1b6db22c0c3d1ee360082d2c0931f3
      size: 3221
    params:
      config/config.yaml:
        data:
          prob_train: 0.8
          training_size:
          - 150
          - 150
          crop_size:
          delimiter: _
          maxvalues:
          - 255
          - 1023
          - 1023
          root_folder: data
          suffixes:
          - _RGB.png
          - _NIR.png
          - _UV.png
          channel_list:
          use_segmentation_masks: true
          train:
          - - train_list.txt
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/jsons
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/images
          - - train_list.txt
            - 20240220_142555_Img_20240220_goods/jsons
            - 20240220_142555_Img_20240220_goods/images
          - - train_list.txt
            - 20240312_210918_prod/jsons
            - 20240312_210918_prod/images
          - - train_list.txt
            - 20240312_210929_prod/jsons
            - 20240312_210929_prod/images
          - - train_list.txt
            - 20240321_162918_Img_20240321_162913/jsons
            - 20240321_162918_Img_20240321_162913/images
          - - train_list.txt
            - 20240321_172502_defectos_rotando/jsons
            - 20240321_172502_defectos_rotando/images
          - - train_list.txt
            - 20240805/jsons
            - 20240805/images
          val:
          - - val_list.txt
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/jsons
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/images
          - - val_list.txt
            - 20240220_142555_Img_20240220_goods/jsons
            - 20240220_142555_Img_20240220_goods/images
          - - val_list.txt
            - 20240312_210918_prod/jsons
            - 20240312_210918_prod/images
          - - val_list.txt
            - 20240312_210929_prod/jsons
            - 20240312_210929_prod/images
          - - val_list.txt
            - 20240321_162918_Img_20240321_162913/jsons
            - 20240321_162918_Img_20240321_162913/images
          - - val_list.txt
            - 20240321_172502_defectos_rotando/jsons
            - 20240321_172502_defectos_rotando/images
          - - val_list.txt
            - 20240805/jsons
            - 20240805/images
        model:
          defect_types:
          - Pedunculo
          - Contraped
          num_channels_input: 5
          model_version: 50
        train:
          initial_model:
          batch_size: 40
          in_memory: false
          num_workers: 10
          epochs: 60
          unfreeze_epoch: 6
          warmup: 3
          learning_rate: 0.002
          optimizer: adam
          gamma_param: 0.1
          label_smoothing: 0.1
          p_dropout: 0.5
          weights_decay: 0.001
          output:
            model_file: orange_seg_ped_cped.pkl
            path: out_models
          min_defect_area: 50
          constrain_weight: 5.0
          min_negative_fraction: 0.95
          bottom_constrain_weight: 1.0
          binmask_weight: 30.0
          class_weights:
          - 1.0
          - 1.0
          logname: orange_mil_segmentation
          wandb_project: DVC_orange_segmentation
          log_cimg: data/test/log_cimg/im_log.cimg
          augmentation:
            random_rotation: 30
            brightness:
            - 0.8
            - 1.4
            contrast:
            - 0.8
            - 1.55
            hue: 0.01
            saturation: 0.15
            blur:
            - 0.1
            - 1.5
            affine:
              scale:
              - 0.7
              - 1.1
              shear: 15
              translate:
              - 0.15
              - 0.15
              degrees: 30
    outs:
    - path: out_models/orange_seg_ped_cped.pkl
      hash: md5
      md5: 71528f5dc51f94734065e437792ad941
      size: 262701680
  evaluate:
    cmd: python ../src_view_segmentation/evaluate/evaluate.py config/config.yaml
    deps:
    - path: ../src_view_segmentation/evaluate/evaluate.py
      hash: md5
      md5: d96c37b74125411ea8e55cb23ecd0140
      size: 9131
    - path: out_models/orange_seg_ped_cped.pkl
      hash: md5
      md5: 71528f5dc51f94734065e437792ad941
      size: 262701680
    params:
      config/config.yaml:
        data:
          prob_train: 0.8
          training_size:
          - 150
          - 150
          crop_size:
          delimiter: _
          maxvalues:
          - 255
          - 1023
          - 1023
          root_folder: data
          suffixes:
          - _RGB.png
          - _NIR.png
          - _UV.png
          channel_list:
          use_segmentation_masks: true
          train:
          - - train_list.txt
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/jsons
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/images
          - - train_list.txt
            - 20240220_142555_Img_20240220_goods/jsons
            - 20240220_142555_Img_20240220_goods/images
          - - train_list.txt
            - 20240312_210918_prod/jsons
            - 20240312_210918_prod/images
          - - train_list.txt
            - 20240312_210929_prod/jsons
            - 20240312_210929_prod/images
          - - train_list.txt
            - 20240321_162918_Img_20240321_162913/jsons
            - 20240321_162918_Img_20240321_162913/images
          - - train_list.txt
            - 20240321_172502_defectos_rotando/jsons
            - 20240321_172502_defectos_rotando/images
          - - train_list.txt
            - 20240805/jsons
            - 20240805/images
          val:
          - - val_list.txt
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/jsons
            - 20240219_190526_Img_20240219_NaranjaRottEncoder/images
          - - val_list.txt
            - 20240220_142555_Img_20240220_goods/jsons
            - 20240220_142555_Img_20240220_goods/images
          - - val_list.txt
            - 20240312_210918_prod/jsons
            - 20240312_210918_prod/images
          - - val_list.txt
            - 20240312_210929_prod/jsons
            - 20240312_210929_prod/images
          - - val_list.txt
            - 20240321_162918_Img_20240321_162913/jsons
            - 20240321_162918_Img_20240321_162913/images
          - - val_list.txt
            - 20240321_172502_defectos_rotando/jsons
            - 20240321_172502_defectos_rotando/images
          - - val_list.txt
            - 20240805/jsons
            - 20240805/images
        evaluate:
          model_dir: out_models
          model_file: orange_seg_ped_cped.pkl
          report_dir: out_evaluate
          train_predictions: train_scores.json
          val_predictions: val_scores.json
          aucs: aucs.json
        model:
          defect_types:
          - Pedunculo
          - Contraped
          num_channels_input: 5
          model_version: 50
    outs:
    - path: out_evaluate/aucs.json
      hash: md5
      md5: 6a20852ab3212c556ccdb5f1d0b10347
      size: 374
    - path: out_evaluate/train_scores.json
      hash: md5
      md5: 336ec3247f050694e98facad91b62bdb
      size: 1821732
    - path: out_evaluate/val_scores.json
      hash: md5
      md5: 156cc214f8ab18dd4b07fa4e2155ac64
      size: 485823
  report:
    cmd: jupyter nbconvert --to notebook --execute reports/analisis_prestaciones.ipynb
    deps:
    - path: out_evaluate/aucs.json
      hash: md5
      md5: 6a20852ab3212c556ccdb5f1d0b10347
      size: 374
    - path: out_evaluate/train_scores.json
      hash: md5
      md5: 336ec3247f050694e98facad91b62bdb
      size: 1821732
    - path: out_evaluate/val_scores.json
      hash: md5
      md5: 156cc214f8ab18dd4b07fa4e2155ac64
      size: 485823
    - path: reports/analisis_prestaciones.ipynb
      hash: md5
      md5: 7e7ada9c55b612aba0302b7a3d5ecec9
      size: 57441
    outs:
    - path: reports/analisis_prestaciones.nbconvert.ipynb
      hash: md5
      md5: 29d26367ee353f0260f419794d74f6ee
      size: 56221
